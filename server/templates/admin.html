<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SnapClass Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-purple: #8b5cf6;
        --secondary-purple: #a78bfa;
        --light-purple: #e9d5ff;
        --dark-purple: #7c3aed;
        --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        --bg-gradient: linear-gradient(
          135deg,
          #faf5ff 0%,
          #f3e8ff 50%,
          #e9d5ff 100%
        );
        --text-dark: #374151;
        --border-color: #d1d5db;
        --shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.1),
          0 10px 10px -5px rgba(139, 92, 246, 0.04);
        --shadow-hover: 0 20px 25px -5px rgba(139, 92, 246, 0.15),
          0 10px 10px -5px rgba(139, 92, 246, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        background: var(--bg-gradient);
        min-height: 100vh;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--text-dark);
        line-height: 1.6;
      }

      /* Header Styles */
      .header {
        background: var(--purple-gradient);
        color: white;
        padding: 1rem 0;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header h1 {
        margin: 0;
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: 700;
        text-align: center;
      }

      .header .subtitle {
        text-align: center;
        opacity: 0.9;
        font-size: clamp(0.875rem, 2vw, 1rem);
        margin-top: 0.25rem;
      }

      /* Container Responsive */
      .main-container {
        padding: clamp(1rem, 3vw, 2rem);
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Card Styles */
      .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 92, 246, 0.1);
        border-radius: 1rem;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .card:hover {
        box-shadow: var(--shadow-hover);
        transform: translateY(-2px);
      }

      .card-header {
        background: var(--purple-gradient);
        color: white;
        padding: 1.25rem;
        border: none;
        font-weight: 600;
        font-size: clamp(1.125rem, 2.5vw, 1.25rem);
      }

      /* Navigation Tabs */
      .nav-tabs {
        border: none;
        margin-bottom: 1.5rem;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 0.75rem;
        padding: 0.25rem;
        box-shadow: var(--shadow);
      }

      .nav-tabs .nav-link {
        border: none;
        border-radius: 0.5rem;
        color: var(--primary-purple);
        font-weight: 500;
        padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 3vw, 1.5rem);
        margin: 0.125rem;
        transition: all 0.3s ease;
        font-size: clamp(0.875rem, 2vw, 1rem);
      }

      .nav-tabs .nav-link:hover {
        background: var(--light-purple);
        color: var(--dark-purple);
      }

      .nav-tabs .nav-link.active {
        background: var(--purple-gradient);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      /* Form Styles */
      .form-control,
      .btn {
        border-radius: 0.5rem;
        border: 2px solid var(--border-color);
        padding: clamp(0.5rem, 2vw, 0.75rem);
        font-size: clamp(0.875rem, 2vw, 1rem);
        transition: all 0.3s ease;
      }

      .form-control:focus {
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
      }

      .form-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        font-size: clamp(0.875rem, 2vw, 0.95rem);
      }

      /* Button Styles */
      .btn {
        font-weight: 600;
        padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 3vw, 1.5rem);
        border: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: clamp(0.875rem, 2vw, 0.95rem);
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
      }

      .btn-primary {
        background: var(--purple-gradient);
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(139, 92, 246, 0.4);
      }

      .btn-outline-primary {
        border: 2px solid var(--primary-purple);
        color: var(--primary-purple);
        background: transparent;
      }

      .btn-outline-primary:hover {
        background: var(--primary-purple);
        color: white;
        transform: translateY(-1px);
      }

      /* Status and Output Sections */
      .status-section,
      .output-section {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-top: 1.5rem;
        border: 1px solid var(--light-purple);
      }

      #statusContent {
        font-family: "JetBrains Mono", "Courier New", monospace;
        background: rgba(249, 250, 251, 0.8);
        padding: 1rem;
        border-radius: 0.5rem;
        max-height: clamp(300px, 40vh, 500px);
        overflow-y: auto;
        border: 1px solid var(--border-color);
        font-size: clamp(0.75rem, 1.5vw, 0.875rem);
      }

      .output-pre {
        background: rgba(249, 250, 251, 0.9);
        padding: 1rem;
        border-radius: 0.5rem;
        max-height: clamp(150px, 25vh, 250px);
        overflow-y: auto;
        border: 1px solid var(--border-color);
        font-size: clamp(0.75rem, 1.5vw, 0.875rem);
        font-family: "JetBrains Mono", "Courier New", monospace;
      }

      /* Questions List */
      .list-group-item {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--light-purple);
        border-radius: 0.5rem !important;
        margin-bottom: 0.5rem;
        padding: 1rem;
        font-size: clamp(0.875rem, 2vw, 0.95rem);
        transition: all 0.3s ease;
      }

      .list-group-item:hover {
        background: var(--light-purple);
        transform: translateX(4px);
      }

      .question-list {
        max-height: clamp(250px, 35vh, 400px);
        overflow-y: auto;
      }

      /* Loading Overlay */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(139, 92, 246, 0.1);
        backdrop-filter: blur(8px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }

      .loading-popup {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: clamp(1.5rem, 4vw, 2.5rem);
        border-radius: 1.25rem;
        box-shadow: 0 25px 50px -12px rgba(139, 92, 246, 0.25);
        text-align: center;
        max-width: 90vw;
        width: 100%;
        max-width: 400px;
        border: 1px solid var(--light-purple);
      }

      .loading-spinner {
        width: clamp(40px, 8vw, 60px);
        height: clamp(40px, 8vw, 60px);
        border: 4px solid var(--light-purple);
        border-top: 4px solid var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-popup h4 {
        color: var(--primary-purple);
        font-size: clamp(1.125rem, 3vw, 1.5rem);
        margin-bottom: 0.5rem;
      }

      .loading-popup p {
        color: var(--text-dark);
        opacity: 0.8;
        font-size: clamp(0.875rem, 2vw, 1rem);
        margin: 0;
      }

      /* Content Updates */
      .content-update {
        background: rgba(139, 92, 246, 0.05);
        border-left: 4px solid var(--primary-purple);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 0.5rem 0.5rem 0;
      }

      .status-update {
        background: rgba(16, 185, 129, 0.05);
        border-left: 4px solid #10b981;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: 0 0.5rem 0.5rem 0;
        font-size: clamp(0.75rem, 1.5vw, 0.875rem);
      }

      /* Responsive Grid */
      @media (max-width: 768px) {
        .main-container {
          padding: 1rem;
        }

        .card {
          margin-bottom: 1rem;
        }

        .nav-tabs {
          flex-direction: column;
        }

        .nav-tabs .nav-link {
          text-align: center;
          margin: 0.125rem 0;
        }

        .d-grid {
          margin-top: 1rem;
        }
      }

      @media (max-width: 576px) {
        .header {
          padding: 0.75rem 0;
        }

        .nav-tabs {
          margin-bottom: 1rem;
        }

        .card {
          border-radius: 0.75rem;
        }

        .loading-popup {
          margin: 1rem;
          padding: 1.5rem;
        }
      }

      /* Animation Classes */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up {
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Success/Error States */
      .success-message {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #10b981;
        margin: 1rem 0;
      }

      .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #ef4444;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-popup">
        <div class="loading-spinner"></div>
        <h4><i class="fas fa-magic me-2"></i>Please wait...</h4>
        <p>SnapClass is processing your content...</p>
      </div>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="container">
        <h1><i class="fas fa-graduation-cap me-3"></i>SnapClass</h1>
        <div class="subtitle">Admin Dashboard - Lecture Management System</div>
      </div>
    </div>

    <div class="main-container">
      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs" id="adminTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="upload-tab"
            data-bs-toggle="tab"
            data-bs-target="#upload"
            type="button"
            role="tab"
          >
            <i class="fas fa-cloud-upload-alt me-2"></i>Upload Files
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="analysis-tab"
            data-bs-toggle="tab"
            data-bs-target="#analysis"
            type="button"
            role="tab"
          >
            <i class="fas fa-chart-bar me-2"></i>Test Analysis
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="adminTabContent">
        <!-- Upload Tab -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-8 col-xl-7">
              <div class="card">
                <div class="card-header">
                  <i class="fas fa-file-upload me-2"></i>Upload Lecture
                  Materials
                </div>
                <div class="card-body p-4">
                  <form
                    method="POST"
                    enctype="multipart/form-data"
                    action="/admin"
                  >
                    <div class="row">
                      <div class="col-12 col-md-6 mb-3">
                        <label class="form-label">
                          <i class="fas fa-microphone me-2"></i>Upload Audio:
                        </label>
                        <input
                          type="file"
                          name="audio"
                          class="form-control"
                          accept="audio/*"
                        />
                      </div>
                      <div class="col-12 col-md-6 mb-3">
                        <label class="form-label">
                          <i class="fas fa-file-pdf me-2"></i>Upload PDF:
                        </label>
                        <input
                          type="file"
                          name="pdf"
                          class="form-control"
                          accept=".pdf"
                        />
                      </div>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-2"></i>Upload & Process
                      </button>
                    </div>
                  </form>

                  <!-- Training Status Section -->
                  <div
                    id="trainingStatus"
                    class="status-section"
                    style="display: none"
                  >
                    <h5 class="text-secondary mb-3">
                      <i class="fas fa-cogs me-2"></i>Live Content Extraction:
                    </h5>
                    <div id="statusContent"></div>
                  </div>

                  <!-- Output Section -->
                  <div
                    id="outputSection"
                    class="output-section"
                    style="display: none"
                  >
                    <h5 class="text-success mb-3">
                      <i class="fas fa-check-circle me-2"></i>Extracted Content
                    </h5>
                    <div class="row">
                      <div class="col-12 col-lg-6 mb-3">
                        <label class="form-label fw-bold">
                          <i class="fas fa-volume-up me-2"></i>Audio
                          Transcription:
                        </label>
                        <pre id="audioOutput" class="output-pre"></pre>
                      </div>
                      <div class="col-12 col-lg-6 mb-3">
                        <label class="form-label fw-bold">
                          <i class="fas fa-file-alt me-2"></i>PDF Extraction:
                        </label>
                        <pre id="pdfOutput" class="output-pre"></pre>
                      </div>
                    </div>
                  </div>

                  <!-- Generate Questions Button -->
                  <div class="d-grid">
                    <button
                      id="generateQuestionsBtn"
                      class="btn btn-primary"
                      style="display: none"
                    >
                      <i class="fas fa-magic me-2"></i>Generate Questions
                    </button>
                  </div>

                  <!-- Clear All Data Button -->
                  <div class="d-grid mt-3">
                    <button
                      id="clearAllDataBtn"
                      class="btn btn-danger"
                      style="display: block"
                    >
                      <i class="fas fa-trash-alt me-2"></i>Clear All Data
                    </button>
                  </div>

                  <!-- Questions Section -->
                  <div
                    id="questionsSection"
                    class="status-section"
                    style="display: none"
                  >
                    <h5 class="text-info mb-3">
                      <i class="fas fa-question-circle me-2"></i>Generated
                      Questions
                    </h5>
                    <div class="question-list">
                      <ul
                        id="questionsList"
                        class="list-group list-group-flush"
                      ></ul>
                    </div>
                    <div class="d-grid mt-3">
                      <button
                        id="publishTestBtn"
                        class="btn btn-success"
                        style="display: none"
                      >
                        <i class="fas fa-share me-2"></i>Publish Test
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Tab -->
        <div class="tab-pane fade" id="analysis" role="tabpanel">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
              <div class="card">
                <div class="card-header">
                  <i class="fas fa-analytics me-2"></i>Student Performance
                  Analysis
                </div>
                <div class="card-body p-4">
                  <div id="analysisContent">
                    <div class="text-center py-4">
                      <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                      <p class="text-muted">
                        Click "Load Analysis" to view student performance data
                      </p>
                    </div>
                  </div>
                  <div class="d-grid">
                    <button
                      class="btn btn-outline-primary"
                      onclick="loadAnalysis()"
                    >
                      <i class="fas fa-refresh me-2"></i>Load Analysis
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Add this new function for handling training updates
      function updateTrainingStatus(message, isContent = false) {
        const statusDiv = document.getElementById("trainingStatus");
        const statusContent = document.getElementById("statusContent");

        statusDiv.style.display = "block";
        statusDiv.classList.add("fade-in");
        const timestamp = new Date().toLocaleTimeString();

        if (isContent) {
          // For actual content, create a formatted display
          const contentDiv = document.createElement("div");
          contentDiv.className = "content-update slide-up";
          contentDiv.innerHTML = `
                    <div class="text-primary mb-2 fw-bold">
                        <i class="fas fa-file-text me-2"></i>[${timestamp}] Page Content:
                    </div>
                    <div class="text-dark">${message}</div>
                `;
          statusContent.appendChild(contentDiv);
        } else {
          // For status updates
          const statusDiv = document.createElement("div");
          statusDiv.className = "status-update slide-up";
          statusDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>[${timestamp}] ${message}
                `;
          statusContent.appendChild(statusDiv);
        }

        statusContent.scrollTop = statusContent.scrollHeight;
      }

      // Add loading overlay functions
      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      // Modify the form submission to handle file upload with status updates
      document.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
          showLoading();
          const response = await fetch("/admin", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            updateTrainingStatus(result.message);
            if (result.updates) {
              result.updates.forEach((update) => {
                if (update.type === "content") {
                  updateTrainingStatus(update.content, true);
                } else {
                  updateTrainingStatus(update.message);
                }
              });
            }
            // Show output texts
            const outputSection = document.getElementById("outputSection");
            outputSection.style.display = "block";
            outputSection.classList.add("fade-in");
            document.getElementById("audioOutput").textContent =
              result.audio_text || "";
            document.getElementById("pdfOutput").textContent =
              result.pdf_text || "";
            const generateBtn = document.getElementById("generateQuestionsBtn");
            generateBtn.style.display = "block";
            generateBtn.classList.add("slide-up");
          } else {
            updateTrainingStatus(`Error: ${result.message}`);
          }
        } catch (error) {
          updateTrainingStatus(`Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      });

      // Keep existing loadAnalysis function
      function loadAnalysis() {
        window.open("/analyse", "_blank");
      }

      // Auto-load analysis when tab is shown
      document
        .getElementById("analysis-tab")
        .addEventListener("shown.bs.tab", loadAnalysis);

      document
        .getElementById("generateQuestionsBtn")
        .addEventListener("click", async () => {
          showLoading();
          updateTrainingStatus(
            "Generating questions from extracted content..."
          );
          try {
            const response = await fetch("/generate_ques", {
              method: "POST",
            });
            const result = await response.json();
            console.log("Result from /generate_ques:", result);
            if (result.success) {
              updateTrainingStatus("Questions generated successfully!");
              const questionsSection =
                document.getElementById("questionsSection");
              const questionsList = document.getElementById("questionsList");
              questionsList.innerHTML = "";
              result.questions.forEach((q, idx) => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary me-3 mt-1">${
                                  idx + 1
                                }</span>
                                <span>${q}</span>
                            </div>
                        `;
                questionsList.appendChild(li);
              });
              questionsSection.style.display = "block";
              questionsSection.classList.add("fade-in");
              // Show the publish button
              const publishBtn = document.getElementById("publishTestBtn");
              publishBtn.style.display = "block";
              publishBtn.classList.add("slide-up");
            } else {
              updateTrainingStatus(`Error: ${result.message}`);
            }
          } catch (error) {
            updateTrainingStatus(`Error: ${error.message}`);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("publishTestBtn")
        .addEventListener("click", async () => {
          showLoading();
          updateTrainingStatus("Publishing test for students...");
          try {
            const response = await fetch("/publish_test", {
              method: "POST",
            });
            const result = await response.json();
            if (result.success) {
              updateTrainingStatus(
                "Test published! Students can now access the test."
              );
            } else {
              updateTrainingStatus(`Error: ${result.message}`);
            }
          } catch (error) {
            updateTrainingStatus(`Error: ${error.message}`);
          } finally {
            hideLoading();
          }
        });

      // Add smooth scrolling to form sections when they appear
      function smoothScrollToElement(element) {
        element.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
        });
      }

      // Enhanced tab switching with animations
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab) => {
        tab.addEventListener("shown.bs.tab", function (e) {
          const targetPane = document.querySelector(
            e.target.getAttribute("data-bs-target")
          );
          targetPane.classList.add("fade-in");
        });
      });

      // Clear All Data functionality
      document
        .getElementById("clearAllDataBtn")
        .addEventListener("click", async () => {
          if (
            confirm(
              "Are you sure you want to clear all data? This will delete:\n\n• Generated questions\n• Published tests\n• Student submissions\n• Analysis data\n• All output files\n\nThis action cannot be undone!"
            )
          ) {
            showLoading();
            updateTrainingStatus("Clearing all data...");
            try {
              const response = await fetch("/clear_all_data", {
                method: "POST",
              });
              const result = await response.json();
              if (result.success) {
                updateTrainingStatus(
                  `Successfully cleared ${result.deleted_count} files!`
                );
                // Hide sections that depend on the cleared data
                document.getElementById("outputSection").style.display = "none";
                document.getElementById("questionsSection").style.display =
                  "none";
                document.getElementById("generateQuestionsBtn").style.display =
                  "none";
                document.getElementById("publishTestBtn").style.display =
                  "none";
                // Clear the questions list
                document.getElementById("questionsList").innerHTML = "";
                // Clear output displays
                document.getElementById("audioOutput").textContent = "";
                document.getElementById("pdfOutput").textContent = "";
                // Clear status content
                document.getElementById("statusContent").innerHTML = "";
                document.getElementById("trainingStatus").style.display =
                  "none";
              } else {
                updateTrainingStatus(`Error: ${result.message}`);
              }
            } catch (error) {
              updateTrainingStatus(`Error: ${error.message}`);
            } finally {
              hideLoading();
            }
          }
        });
    </script>
  </body>
</html>
